---
import PageLoader from '../components/PageLoader.astro';
import Landing from '../components/Landing.astro';
import Nav from '../components/Nav.astro';
import Profile from '../components/Profile.astro';
import Gallery from '../components/Gallery.astro';
// install via `npm i airtable`
import Airtable from 'airtable'

// ini contoh pake airtable, docs nya udah cukup bagus bisa ikutin aja disini https://airtable.com/api
// tapi ini aku contohin pake project ku ya:

Airtable.configure({
    endpointUrl: 'https://api.airtable.com',
    // replace apiKey based on docs di airtable
    apiKey: import.meta.env.AIRTABLE_API_KEY
});

// base ini juga ambil dari docs airtable
const base = Airtable.base(import.meta.env.AIRTABLE_BASE_KEY);

// ambil search params via contoh -> anaLalala.com?untuk=Miles Cruz
const invitationCode = Astro.url.searchParams.get('invitationCode')?.trim()?.toLowerCase();

const invitationData = await base('Invitations')
  .select()
  .all()
  .then(records => {
    return records.map(r => {
      return {
        name: r.fields['Invitee Name'],
        pax: r.fields['Pax'],
        category: r.fields['Category'],
        vip: r.fields['VIP'],
        invitationCode: r.fields['Invitation Code'],
      }
    })

    // would be better to consider caching via redis (bisa explore https://upstash.com/)
  })
  .catch((err) => {
    console.error(err)
  });

const foundInvitedPerson = invitationData.find(d => d.invitationCode == invitationCode)

// ini buat redirection (kalo perlu), kalo namanya ga ketemu redirect ke /404
if (!foundInvitedPerson) {
  return Astro.redirect('/404')
}
---

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ana & Windu Wedding Day</title>
  <link href="https://fonts.cdnfonts.com/css/vollkorn" rel="stylesheet" />
  <link href="https://fonts.cdnfonts.com/css/great-vibes" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet" />
</head>

<body class="h-full">
  <PageLoader />
  <!-- Invitation Landing -->
  <div id="invitation-landing-bg"
    class="absolute inset-0 z-20 bg-black bg-opacity-50 backdrop-blur-sm
    transition-all ease-in-out duration-500 h-screen">
  </div>
  <div id="invitation-landing"
    class="absolute inset-0 z-30
    flex justify-center items-center transition-all
    ease-in-out duration-500 h-screen">
    <div class="container px-4 mx-auto text-cafe-noir-300 bg-champagne-pink-300">
      <div class="max-w-4xl mx-auto text-center divide-y divide-cafe-noir-300">
        <div class="py-4">
          <span
            class="text-lg lg:text-xl text-cinnamon-satin-200
            font-sans font-semibold uppercase tracking-widest">
            Dear <br />{foundInvitedPerson.name},
          </span>
          <p class="mt-4 font-sans font-semibold">Dengan penuh sukacita, kami mengundang saudara/i untuk menghadiri pernikahan kami.</p>
        </div>
        <div class="py-4">
          <span
          class="text-base lg:text-lg font-sans font-semibold uppercase tracking-widest">
          The Wedding of
        </span>
        <h2 class="mt-3 text-5xl lg:text-6xl font-bold font-cursive">Ana &amp; Windu</h2>
        <button onclick="openInvitation()"
          class="mt-4 py-2 px-4 uppercase font-semibold bg-transparent rounded-full
          text-champagne-pink-500 border-cinnamon-satin-200 bg-cinnamon-satin-200">
          Buka Undangan
        </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    let openInvitation = function() {
      panelInvitation = document.getElementById("invitation-landing")
      panelInvitationBackground = document.getElementById("invitation-landing-bg")
      panelInvitation.classList.toggle('-translate-y-full')
      panelInvitationBackground.classList.toggle('backdrop-blur-sm')
      panelInvitationBackground.classList.toggle('bg-black')
      panelInvitationBackground.classList.toggle('invisible')

      var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      window.song = audioCtx.createBufferSource();
      window.tryStartSong = 0;
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/assets/sax-cant-help-falling-in-love.mp3');
      xhr.responseType = 'arraybuffer';
      xhr.addEventListener('load', function (r) {
          audioCtx.decodeAudioData(
                  xhr.response, 
                  function (buffer) {
                      window.song.buffer = buffer;
                      window.song.connect(audioCtx.destination);
                      window.song.volume = 0.2;
                      window.song.loop = true;
                  });
      });
      xhr.send();
      window.song.start(0);
    }
  </script>
  <!-- End of Invitation Landing -->

  <div id="page-content"
    class="h-screen snap-y snap-mandatory overflow-auto">
    <!-- Debug, uncomment aja buat liat semua data di airtable -->
    <!-- <h2>Daftar Undangan:</h2> -->
    <!-- <pre>{JSON.stringify(data, null, 2)}</pre> -->

    <!-- Start of Section 1 - Beranda -->
    <div class="snap-center">
      <Nav />
      <Landing />
    </div>
    <!-- End of Section 1 -->

    <!-- Start of Section 2 - Profil -->
    <div class="snap-center">
      <Profile />
    </div>
    <!-- End of Section 2 -->

    <!-- Start of Section 3 - Galeri -->
    <div class="snap-center">
      <div class="w-full h-screen bg-center bg-cover bg-champagne-pink-500 text-cafe-noir-500">
        <div class="flex justify-center w-full h-full">
          <div class="container px-4 mx-auto py-8">
            <!-- Content here -->
            <div class="max-w-4xl mx-auto text-center items-center">
              <span
                class="text-xl font-sans font-semibold uppercase pb-4 tracking-wide">
                Galeri Foto
              </span>
            </div>
            <Gallery />
          </div>
        </div>
      </div>
    </div>
    <!-- End of Section 3 -->    

    <!-- Start of Section 4 - Jadwal -->
    <div class="snap-center">
      <div class="w-full h-screen bg-center bg-cover"
        style="background-image: url('/assets/hero-cover2.jpg')">
        <div class="flex justify-center w-full h-full bg-opacity-75 bg-black">
          <div class="container px-4 mx-auto py-8 text-champagne-pink-300">
            <div class="max-w-4xl mx-auto text-center items-center">
              <span
                class="text-xl font-sans font-semibold uppercase pb-4 tracking-wide text-cinnamon-satin-100">
                Waktu Acara
              </span>
            </div>
            <div class="flex flex-col h-full w-full justify-center items-center space-y-12 px-6 lg:px-10">
              <div class="grid grid-cols-3 lg:grid-cols-4 grid-rows-1 gap-2 lg:gap-4 w-full">
                <div class="lg:col-span-2 text-2xl lg:text-3xl font-sans pb-4 tracking-wide text-right px-4 lg:px-6">
                  <span
                    class="font-semibold font-cursive text-cinnamon-satin-100">
                    Akad
                  </span>
                </div>
                <div class="col-span-2 text-lg font-sans tracking-wide">
                  <p>Minggu</p>
                  <p>11 Desember 2022</p>
                  <p>10:00 WIB</p>
                  <p>Casakhasa, Kemang</p>
                  <p>Jakarta Selatan</p>
                </div>
              </div>
              <div class="grid grid-cols-3 lg:grid-cols-4 grid-rows-1 gap-2 lg:gap-4 w-full">
                <div class="lg:col-span-2 text-2xl lg:text-3xl font-sans pb-4 tracking-wide text-right px-4 lg:px-6">
                  <span
                    class="font-semibold font-cursive text-cinnamon-satin-100">
                    Resepsi
                  </span>
                </div>
                <div class="col-span-2 text-lg font-sans tracking-wide">
                  <p>Minggu</p>
                  <p>11 Desember 2022</p>
                  <p>12:00 - 14:00 WIB</p>
                  <p>Casakhasa, Kemang</p>
                  <p>Jakarta Selatan</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End of Section 4 -->
  </div>
</body>
</html>
